scheduled_tasks: &scheduled_tasks
  scheduled_tasks:
      # 10AM JST every week day
      - schedule: cron(0 1 ? * MON-FRI *)
        command: bin/chaos
      # every 5 minutes
      # - schedule: cron(0/5 * ? * * *)
      #   command: rake bcn:deployment_check
      # TODO IMPLEMENT A CHECKING FLAG SO TWO TASKS DO NOT COLLIDE

environments:
  production:
    <<: *scheduled_tasks
    name: barcelona2
    image_name: public.ecr.aws/degica/barcelona
    before_deploy: rake db:migrate
    services:
      - name: web
        service_type: web
        cpu: 128
        memory: 256
        command: puma -C config/puma.rb
        web_container_port: 3000
        force_ssl: true
        listeners:
          - endpoint: barcelona-second
            health_check_path: /health_check
      - name: worker
        command: rake jobs:work
        cpu: 128
        memory: 256
  test:
    <<: *scheduled_tasks
    name: barcelona
    image_name: public.ecr.aws/degica/barcelona
    before_deploy: rake db:migrate
    services:
      - name: web
        service_type: web
        cpu: 128
        memory: 256
        command: puma -C config/puma.rb
        web_container_port: 3000
        force_ssl: true
        listeners:
          - endpoint: barcelona
            health_check_path: /health_check
      - name: worker
        command: rake jobs:work
        cpu: 128
        memory: 256
 